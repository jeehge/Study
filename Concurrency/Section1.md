# Section I: Modern Concurrency in Swift

### 1. Why Modern Swift Concurrency?

애플이 비동기식 프레임워크에 대해 큰 관심을 보인 것은 2009년 Mac OS X 스노우 레오파드와 함께 GCD(Grand Central Dispatch)가 나왔을 때 입니다.

GCD는 2014년 Swift부터 동시성과 비동기성을 지원하면서 출시하는 데 도움을 주었지만, 이러한 지원이 기본적인 것은 아니었습니다.

이는 Objective-C의 요구와 능력을 중심으로 설계되었으며, Swift는 언어에 맞게 특별히 설계된 자체 메커니즘을 갖출 때까지 이러한 동시성을 "빌려" 왔습니다.

이 모든 것은 비동기 동시 코드 작성을 위한 새로운 네이티브 모델을 도입한 Swift 5.5와 함께 바뀌었습니다.

<br>

새로운 concurrency model은 Swift에서 안전하고 성능이 뛰어난 프로그램을 작성하는 데 필요한 다음과 같은 모든 것을 제공합니다:
- 구조화된 방식으로 비동기 작업을 실행하기 위한 새로운 기본 구문입니다.
- 비동기 코드와 동시 코드를 설계하기 위한 표준 API 묶음.
- libdispatch framework(?)의 low-level 변경으로 모든 상위 수준 변경이 운영 체제에 직접 통합됩니다.
- 안전한 동시 코드를 만들기 위한 새로운 수준의 컴파일러 지원.

<br>

Swift 5.5는 이러한 기능을 지원하기 위해 새로운 언어 구문과 API를 소개합니다. 
앱에서는 최근 Swift 버전을 사용하는 것 외에 특정 플랫폼 버전을 대상으로 해야 합니다:

- Xcode 13.2 이상을 사용하는 경우 새로운 동시 실행 시간을 앱과 함께 번들로 제공하여 iOS 13 및 macOS 10.15(네이티브 앱용)를 대상으로 할 수 있습니다.

- Xcode 13에서 13.2보다 이전 버전인 경우 iOS 15 또는 macOS 12(또는 그 이상)만 대상으로 지정할 수 있습니다.

책의 첫 장에서는 스위프트의 새로운 concurrency 지원에 대해 검토하고 기존 API와 비교하여 어떻게 구현되는지 확인할 것입니다. 

나중에 chapter의 실용적인 부분에서는  `async/await` 구문을 사용해보고 멋진 asynchronous error-handling을 추가하여 실제 프로젝트를 수행할 것입니다.


### 1-1. Understanding asynchronous and concurrent code 비동기 및 동기 코드 이해

대부분의 코드는 코드 편집기에서 작성된 것과 같은 방식으로 실행됩니다. 위에서 아래로, 기능의 시작 부분에서 시작하여 줄 단위로 끝까지 진행됩니다.

이를 통해 주어진 코드 라인이 실행되는 시기를 쉽게 결정할 수 있습니다. 단순히 이전 코드 라인을 따릅니다. 함수 호출에 대해서도 마찬가지입니다. 코드가 동시에 실행되면 실행이 순차적으로 발생합니다.

동기적 맥락에서 코드는 하나의 CPU 코어의 하나의 실행 스레드에서 실행됩니다. 

단일 차선 도로에서 자동차와 같은 동기식 기능을 상상할 수 있으며, 한 차량이 근무 중인 구급차와 같이 우선 순위가 높은 경우 나머지 차량을 "jump over" 하여 더 빠르게 운전할 수 없습니다.

(차선이 하나인 곳에 자동차가 순서대로 있는 모습)

반면 iOS 앱과 Cocoa 기반 maOS 앱은 본질적으로 비동기적입니다.

비동기 실행을 사용하면 사용자 입력, 네트워크 연결 등 여러 가지 이벤트에 따라 하나의 thread에서 다른 프로그램 조작을 순서대로 실행할 수 있고 때로는 여러 thread에서 동시에 실행할 수도 있습니다.

특히 여러 비동기 함수가 동일한 thread를 사용해야 하는 경우네느 비동기적인 맥락에서 함수가 실행되는 순서를 정확히 말하기가 어렵습니다.

신호등이 있는 도로와 교통질서가 필요한 곳에서 운전하는 것처럼, 기능은 때때로 차례가 될 때까지 기다리거나 녹색 빛이 진행될 때까지 멈춰야합니다.

신호등이있는 도로와 트래픽이 필요한 곳에서 운전하는 것처럼, 기능은 때때로 차례가 계속 될 때까지 기다리거나 녹색 빛이 진행될 때까지 멈추어야합니다.

(자동차 신호대기 이미지)

비동기 호출의 한 예는 네트워크 요청을 하고 웹 서버가 응답할 때 실행할 완료 폐쇄를 제공하는 것이고, 

완료 콜백을 실행하기 위해 대기하는 동안 앱은 다른 작업를 수행하는 시간을 사용합니다.

(순서도 이미지)

프로그램의 일부를 의도적으로 병렬로 실행하려면 동시 API를 사용합니다. 

어떤 API는 고정된 수의 작업을 동시에 실행할 수 있도록 지원하고, 다른 API는 동시 그룹을 시작하여 임의 수의 동시 작업을 허용합니다.

이로 인해 수많은 동시성 관련 문제가 발생하기도 합니다. 예를 들어, 프로그램의 서로 다른 부분이 서로의 실행을 차단하거나 둘 이상의 함수가 동일한 변수에 동시에 액세스하여 앱이 다운되거나 예기치 않게 앱의 상태가 손상되는, 혐오스러운 데이터 레이스와 마주칠 수 있습니다.

그러나 주의 깊게 사용할 때 동시성은 여러 CPU 코어에서 동시에 다른 기능을 실행함으로써 프로그램을 더 빠르게 실행할 수 있도록 도와주며, 이는 주의 깊은 운전자들이 다차선 고속도로에서 훨씬 더 빠르게 이동할 수 있게 해줍니다.
